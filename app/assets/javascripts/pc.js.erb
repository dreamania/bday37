$(document).ready(function(){
  // ga(['_trackEvent', 'button', 'click', 'img down 1546']);
  // loadJsFile('http://i42.icast-ad.com/track?ccd=1242&mcd=01040601&pcd=1546');
  ga('send', 'event', 'button', 'click', '메인 페이지');
  $('.select_custom_1').selectric();
  $('.select_custom_2').selectric('refresh');
  
  $('#select_month').change(function(e){
    e.preventDefault();
    var month;
    var days;
    month = $("#select_month").val();
    if(month === '3'){
      add_days = [20,21,22,23,24,25,26,27,28,29,30,31];
      remove_days = [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19];
      $.each(remove_days, function( index, value ){
        $("#select_day option[value="+value+"]").remove();
      });
      $.each(add_days, function( index, value ){
        $("#select_day").append($('<option>',{
          value:value,
          text:value
        })).selectric('refresh');
      });
    }else if(month === '4'){
      add_days = [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19];
      remove_days = [20,21,22,23,24,25,26,27,28,29,30,31];
      $.each(remove_days, function( index, value ){
        $("#select_day option[value="+value+"]").remove();
      });
      $.each(add_days, function( index, value ){
        $("#select_day").append($('<option>',{
          value:value,
          text:value
        })).selectric('refresh');
      });
    }
  });
  $("#gift_button").click(function(e){
    e.preventDefault();
    $("#popup_info").bPopup({
      follow: [false, false], //x, y
      position: ['auto', 60], //x, y
      closeClass: 'b-close',
      modalColor: 'black'
    });
    ga('send', 'event', 'button', 'click', '생일 선물 받기');
  });

  $("#popup_info_to_personal").click(function(e){
    e.preventDefault();
    $("#popup_personal").bPopup({
      closeClass: 'b-close-2',
      modalColor: 'black',
      follow: [false, false], //x, y
      position: ['auto', 70] //x, y
      
    });
    ga('send', 'event', 'button', 'click', '개인정보 동의 팝업');
  });

  $("#new_user").bind("ajax:success", function(evt,data,status,xhr){
    response = JSON.parse(xhr.responseText);
    if(response.status==="success"){
      $("#popup_fin1").bPopup({
        closeClass: 'b-close',
        modalColor: 'black',
        follow: [false, false], //x, y
        position: ['auto', 70], //x, y
        onClose: function(){$("#popup_info").bPopup().close();}
      });
    }else {
    }

  }).bind('ajax:error',function(evt,xhr,status,error){
    var $form = $(this),errors,errorText;
    errors = $.parseJSON(xhr.responseText);

    if(errors.status==="duplicated"){
      $("#popup_fin2").bPopup({
        closeClass: 'b-close',
        modalColor: '#000',
        follow: [false, false], //x, y
        position: ['auto', 70], //x, y
        onClose: function(){$("#popup_info").bPopup().close();}
      });
    }
    else{
      validation(errors);
    }
    
  });

  $("#product_button").click(function(e){
    e.preventDefault();
    $("#popup_product").modal({
      // closeClass: 'b-close',
    });
    ga('send', 'event', 'button', 'click', '제품 자세히 보기');

  });

  // $("#info_input_radio").iCheck({
  //   checkboxClass: 'icheckbox_minimal',
  //   radioClass: 'iradio_minimal',
  //   increaseArea: '20%' // option
  // });

  $("#info_phone").mask("999-9999-9999");
  
  $.ajaxSetup({ cache: true });
  $.getScript('//connect.facebook.net/ko_KR/all.js', function(){
    FB.init({
      appId      : '<%= Rails.application.secrets.fb_app_id %>',
      channelUrl : '//<%= Rails.application.secrets.url %>/channel.html', // Channel file for x-domain comms
      status     : true, // check login status
      cookie     : true, // enable cookies to allow the server to access the session
      xfbml      : true  // parse XFBML
    });
    FB.Canvas.setSize();
    FB.Canvas.setAutoGrow();
    $("#facebook_share_link").click(function(e){
      e.preventDefault();
      $.ajax({
        type: "POST",
        url: "/viral_actions.json",
        data: {
          'viral_action[platform]': "Facebook",
          'viral_action[device]': "pc"
        },
        success: function (data) {
        }
        });
      share();
    });
  });

});

function twitter_share()
{
  $.ajax({
    type: "POST",
    url: "/viral_actions.json",
    data: {
      'viral_action[platform]': "Twitter",
      'viral_action[device]': "pc"
    },
    success: function (data) {
    }
    });
}

function validation(errors){
  if(Object.keys(errors).indexOf("phone") == -1){
    //폰없다
    for ( error in errors ) {
      $('input[data-name ='+error+']').parent().find('span').remove();
      $('input[data-name ='+error+']').after('<span class="star">*</span>');
      // $('input[data-name ='+error+']').next().empty('span');
    }
  }else{
    //폰있다
    if(errors.phone.indexOf("has already been taken") !=-1){
      //중복이다
      $("#popup_fin2").bPopup({
        closeClass: 'b-close',
        modalColor: '#000',
        follow: [false, false], //x, y
        position: ['auto', 70], //x, y
        onClose: function(){$("#popup_info").bPopup().close();}
      });
    }else{
      //중복 아니다
      for ( error in errors ) {
        $('input[data-name ='+error+']').parent().find('span').remove();
        $('input[data-name ='+error+']').after('<span class="star">*</span>');
        // $('input[data-name ='+error+']').next().empty('span');
      }
    }
  }
}

function share() {
  var text = "생일을 맞이한 첫 구매 고객님께\n시크릿 프로그래밍 에센스(40ml)를 생일 선물로 드립니다.\n\n지금 쿠폰받기 >\n<%= Rails.application.secrets.url %>";
  var share_content = {
    method: "feed",
    name: "Skin Birthday",
    link: "<%= Rails.application.secrets.url %>/pc/index",
    picture: '<%= Rails.application.secrets.url + asset_url("sns/facebook_share.jpg") %>',
    caption: "숨37과 처음 만나는 오늘이, 피부의 생일입니다.",
    description: text
  };
  FB.ui(share_content, function(response) {
    if(response && response.post_id) {
      track_viral_action(viral_url, "facebook");
      alert("공유되었습니다.");
    }
    else {
      alert("다시 공유해주세요!");
    }
  });
}
